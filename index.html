<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¤§å®¶ä¸€èµ·çŒœæ­Œå§</title>
  <style>
    :root{
      --bg:#1a2858;
      --card:#121a33;
      --card2:#0f1730;
      --text:#eaf0ff;
      --muted:#9bb0ff;
      --border:rgba(255,255,255,.12);
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "PingFang TC", "Noto Sans TC", Arial;
      background: radial-gradient(1200px 800px at 10% 10%, rgba(109,40,217,.35), transparent 55%),
                  radial-gradient(1100px 700px at 90% 25%, rgba(29,78,216,.28), transparent 52%),
                  radial-gradient(900px 700px at 50% 90%, rgba(16,185,129,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .wrap{width:min(980px,100%)}
    header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    h1{
      margin:0;
      font-size:clamp(22px,3vw,30px);
      letter-spacing:.5px;
      line-height:1.1;
    }
    .sub{color:rgba(234,240,255,.78); font-size:14px; line-height:1.35}

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
      header{flex-direction:column}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    }
    .card .hd .label{font-weight:700}
    .card .bd{padding:16px}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:rgba(234,240,255,.9);
      font-size:13px;
      white-space:nowrap;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    button{
      appearance:none;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      letter-spacing:.2px;
      transition: transform .06s ease, background .2s ease, opacity .2s ease;
      user-select:none;
    }
    button:hover{background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.03));}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.45; cursor:not-allowed}

    .btn-primary{
      border-color: rgba(124,58,237,.55);
      background:linear-gradient(180deg, rgba(124,58,237,.45), rgba(124,58,237,.12));
    }
    .btn-good{
      border-color: rgba(16,185,129,.55);
      background:linear-gradient(180deg, rgba(16,185,129,.35), rgba(16,185,129,.10));
    }
    .btn-warn{
      border-color: rgba(245,158,11,.55);
      background:linear-gradient(180deg, rgba(245,158,11,.30), rgba(245,158,11,.08));
    }
    .btn-danger{
      border-color: rgba(239,68,68,.55);
      background:linear-gradient(180deg, rgba(239,68,68,.30), rgba(239,68,68,.08));
    }

    input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    input[type="text"]:focus{border-color:rgba(155,176,255,.55)}

    .status{
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:12px;
      line-height:1.55;
      min-height:54px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .status strong{font-weight:800}
    .status .msg{flex:1; color:rgba(234,240,255,.92)}
    .status .tag{font-size:12px; color:rgba(234,240,255,.72)}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Noto Sans Mono", monospace}

    .tiny{font-size:12px; color:rgba(234,240,255,.72)}
    .help{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(255,255,255,.02);
      color:rgba(234,240,255,.82);
      line-height:1.6;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .smallcard{
      border:1px solid var(--border);
      background:rgba(0,0,0,.14);
      border-radius:16px;
      padding:12px;
    }
    .smallcard h3{margin:0 0 8px 0; font-size:14px}
    .smallcard p{margin:0; font-size:13px; color:rgba(234,240,255,.78); line-height:1.55}

    .progress{
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(124,58,237,.95), rgba(16,185,129,.85));
      transition:width .15s linear;
    }

    .footer{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color:rgba(234,240,255,.65);
      font-size:12px;
    }
    a{color:rgba(155,176,255,.95)}
    .kbd{
      padding:.15em .45em;
      border:1px solid rgba(255,255,255,.2);
      border-bottom-width:2px;
      border-radius:8px;
      background:rgba(255,255,255,.06);
      font-size:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>ğŸµ ä¾†çŒœæ­Œå§ï¼</h1>
        <div class="sub">ä¸»æŒäººä¸€éµæ“ä½œï½œéš¨æ©Ÿæ’­æ”¾ï½œæ¯æ®µ 30 ç§’ï½œå…¨å ´ä¸€èµ·å–Šç­”æ¡ˆ</div>
      </div>
      <div class="row">
        <span class="pill">ğŸ“ æ­Œæ›²è³‡æ–™å¤¾ï¼š<span class="mono">/songs/</span></span>
        <span class="pill">â±ï¸ æ¯æ¬¡æ’­æ”¾ï¼š<strong id="segLabel">30</strong>s</span>
        <span class="pill">ğŸ² ä¸é‡è¤‡ï¼š<strong id="remaining">0</strong> é¦–å‰©é¤˜</span>
      </div>
    </header>

    <div class="grid">
      <!-- Main -->
      <section class="card">
        <div class="hd">
          <div class="label">éŠæˆ²æ§åˆ¶å°</div>
          <div class="row">
            <button id="btnPick" class="btn-primary">ä¾†ä¸€é¦–</button>
            <button id="btnReset" class="btn-danger" title="é‡è¨­æ‰€æœ‰æ­Œæ›²ç‚ºæœªæ’­æ”¾">é‡è¨­</button>
          </div>
        </div>
        <div class="bd">
          <div class="status" aria-live="polite">
            <div class="msg" id="statusMsg">è«‹å…ˆæŒ‰ <strong>ä¾†ä¸€é¦–</strong> æŠ½é¡Œç›®ã€‚</div>
            <div class="tag" id="roundTag">Round â€”</div>
          </div>

          <div style="margin:12px 0 10px">
            <div class="progress" title="æœ¬æ®µ 30 ç§’é€²åº¦">
              <div class="bar" id="bar"></div>
            </div>
          </div>

          <div class="row" style="margin-bottom:10px">
            <button id="btnStart" class="btn-good" disabled>é–‹å§‹</button>
            <button id="btnContinue" class="btn-warn" disabled>ç¹¼çºŒ</button>
            <button id="btnReveal" disabled>çœ‹ç­”æ¡ˆ</button>
            <button id="btnStop" disabled>æš«åœ</button>
          </div>

          <div class="row" style="margin:10px 0 8px">
            <div style="flex:1; min-width:240px">
              <input id="guess" type="text" placeholder="è¼¸å…¥ä½ çŒœçš„æ­Œåï¼ˆå¯æŒ‰ Enter é€å‡ºï¼‰" autocomplete="off" />
            </div>
            <button id="btnGuess" class="btn-primary" disabled>çŒœæ­Œ</button>
          </div>

          <div class="help">
            <div class="tiny">âœ… å»ºè­°ä¸»æŒäººå£æ’­ï¼š</div>
            <ul style="margin:6px 0 0 18px; padding:0">
              <li>æŒ‰ <strong>é–‹å§‹</strong> æ’­æ”¾ 30 ç§’ï¼Œå¤§å®¶ä¸€èµ·çŒœï¼</li>
              <li>çŒœä¸åˆ°å°±æŒ‰ <strong>ç¹¼çºŒ</strong> å†è½ 30 ç§’ã€‚</li>
              <li>å…¨å ´çœŸçš„æƒ³ä¸åˆ°å°±æŒ‰ <strong>çœ‹ç­”æ¡ˆ</strong> æ­æ›‰ã€‚</li>
              <li>æ¯é¦–æ­Œåªæœƒå‡ºç¾ä¸€æ¬¡ï¼›æƒ³é‡ç©è«‹æŒ‰ <strong>é‡è¨­</strong>ã€‚</li>
            </ul>
          </div>

          <audio id="audio" preload="metadata"></audio>

          <div class="footer">
            <div>å¿«æ·éµï¼š<span class="kbd">Enter</span> é€å‡ºçŒœæ­Œï½œ<span class="kbd">Space</span> æ’­æ”¾/æš«åœ</div>
            <div class="mono" id="debug"></div>
          </div>
        </div>
      </section>

      <!-- Side -->
      <aside class="card">
        <div class="hd">
          <div class="label">ç¾å ´è¨­å®š</div>
          <div class="pill">ğŸ›ï¸ å¯é›¢ç·šä½¿ç”¨</div>
        </div>
        <div class="bd">
          <div class="list">
            <div class="smallcard">
              <h3>â‘  æº–å‚™æ­Œæ›²</h3>
              <p>åœ¨åŒä¸€å±¤ç›®éŒ„å»ºç«‹ <span class="mono">songs</span> è³‡æ–™å¤¾ï¼Œæ”¾å…¥å¤šé¦– <span class="mono">.mp3</span>ï¼ˆæˆ– <span class="mono">.wav</span>ï¼‰ã€‚<br>æª”åå°±æ˜¯æ­Œåï¼šä¾‹å¦‚ <span class="mono">å‘Šç™½æ°£çƒ.mp3</span></p>
            </div>
            <div class="smallcard">
              <h3>â‘¡ è¨­å®šæ­Œå–®</h3>
              <p>å› ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œå–®ä¸€ HTML ç„¡æ³•è‡ªå‹•è®€è³‡æ–™å¤¾å…§å®¹ï¼›è«‹åˆ°ç¨‹å¼ç¢¼ä¸­æ‰¾åˆ° <span class="mono">SONG_FILES</span> é™£åˆ—ï¼ŒæŠŠæª”åå¡«é€²å»å³å¯ã€‚</p>
            </div>
            <div class="smallcard">
              <h3>â‘¢ ç¾å ´æ’­æ”¾å»ºè­°</h3>
              <p>ç”¨ç­†é›»æ¥éŸ³éŸ¿ã€Chrome å…¨è¢å¹•ã€‚æ’­æ”¾æŒ‰éˆ•ç”±ä¸»æŒäººæ§åˆ¶ï¼Œå…¨å ´ç”¨å–Šçš„æˆ–ç”¨æ‰‹æ©Ÿ/ç™½æ¿è¼¸å…¥çš†å¯ã€‚</p>
            </div>
            <div class="smallcard">
              <h3>å¸¸è¦‹å•é¡Œ</h3>
              <p><strong>Qï¼š</strong> é»é–‹å§‹æ²’è²éŸ³ï¼Ÿ<br><strong>Aï¼š</strong> å…ˆæŒ‰ä¸€æ¬¡æŒ‰éˆ•è§¸ç™¼æ’­æ”¾æ¬Šé™ã€éŸ³é‡èª¿å¤§ã€ç¢ºèªéŸ³è¨Šæ ¼å¼æ”¯æ´ã€‚</p>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    /**
     * ä¾†çŒœæ­Œå§ï¼å–®ä¸€ç¶²é ç‰ˆ
     *
     * âš ï¸ é‡è¦ï¼šç€è¦½å™¨åŸºæ–¼å®‰å…¨æ€§ï¼Œç„¡æ³•ç›´æ¥åˆ—å‡º /songs ç›®éŒ„å…§å®¹ã€‚
     *     ä½ éœ€è¦åœ¨ä¸‹é¢ SONG_FILES æ‰‹å‹•å¡«å…¥æ­Œæ›²æª”åï¼ˆæª”å=æ­£ç¢ºæ­Œåï¼‰ã€‚
     *
     * ä½¿ç”¨æ–¹å¼ï¼š
     * 1) å°‡æ­¤æª”æ¡ˆå­˜ç‚º index.html
     * 2) å»ºç«‹ songs/ è³‡æ–™å¤¾ï¼Œæ”¾å…¥æ­Œæ›²æª”
     * 3) åœ¨ SONG_FILES å¡«å…¥æª”åï¼Œä¾‹å¦‚ "å‘Šç™½æ°£çƒ.mp3"
     * 4) ç”¨æœ¬æ©Ÿä¼ºæœå™¨é–‹å•Ÿï¼ˆå»ºè­°ï¼‰ï¼š
     *    - VSCode Live Server
     *    - æˆ–å‘½ä»¤åˆ—ï¼špython -m http.server 8000
     */

    // âœ… åœ¨é€™è£¡å¡«å…¥ä½ çš„æ­Œæ›²æª”åï¼ˆæª”åå³æ­Œåï¼‰
    const SONG_FILES = [
      "å¥½å¥½å…ˆç”Ÿ.mp3",
      "å‘Šç™½æ°£çƒ.mp3",
      "ç­‰ä½ ä¸‹èª².mp3",
      "ç¼ºå£.mp3",
      "è¸ç‰›.mp3",
    ];

    // æ¯æ®µæ’­æ”¾ç§’æ•¸ï¼ˆå¯èª¿ï¼‰
    const SEGMENT_SECONDS = 30;

    // ------- DOM -------
    const $ = (sel) => document.querySelector(sel);
    const btnPick = $("#btnPick");
    const btnReset = $("#btnReset");
    const btnStart = $("#btnStart");
    const btnContinue = $("#btnContinue");
    const btnReveal = $("#btnReveal");
    const btnStop = $("#btnStop");
    const btnGuess = $("#btnGuess");
    const guessInput = $("#guess");
    const statusMsg = $("#statusMsg");
    const roundTag = $("#roundTag");
    const audio = $("#audio");
    const bar = $("#bar");
    const remainingEl = $("#remaining");
    const segLabel = $("#segLabel");
    const debugEl = $("#debug");

    segLabel.textContent = String(SEGMENT_SECONDS);

    // ------- State -------
    /** @type {string[]} */
    let pool = [];            // æœªæ’­æ”¾æ­Œæ›²
    /** @type {string|null} */
    let currentFile = null;   // ç›®å‰æ­Œæ›²æª”å
    let currentAnswer = null; // ç›®å‰ç­”æ¡ˆï¼ˆæª”åå»å‰¯æª”åï¼‰
    let round = 0;

    // segment timer
    let segTimer = null;
    let segStartAt = 0;
    let segTargetMs = SEGMENT_SECONDS * 1000;

    // ------- Helpers -------
    function setStatus(html){
      statusMsg.innerHTML = html;
    }

    function setRoundTag(text){
      roundTag.textContent = text;
    }

    function setRemaining(){
      remainingEl.textContent = String(pool.length);
    }

    function resetProgress(){
      bar.style.width = "0%";
    }

    function startProgress(){
      // progress uses requestAnimationFrame driven by interval for simplicity
      const start = performance.now();
      const duration = segTargetMs;
      const tick = () => {
        const now = performance.now();
        const t = Math.min(1, (now - start) / duration);
        bar.style.width = (t * 100).toFixed(1) + "%";
        if (t < 1 && !audio.paused) requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }

    function normalize(s){
      return (s || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ")
        // å¸¸è¦‹ç¬¦è™Ÿå·®ç•°ç°¡å–®è™•ç†
        .replace(/[â€œâ€"'â€™]/g, "")
        .replace(/[ï¼!]/g, "")
        .replace(/[ï¼Ÿ?]/g, "")
        .replace(/[ï¼ã€‚]/g, "")
        .replace(/[ï¼Œ,]/g, "")
        .replace(/[ï¼š:]/g, "");
    }

    function fileToTitle(filename){
      return filename.replace(/\.[^/.]+$/, "");
    }

    function enable(el, yes){
      el.disabled = !yes;
    }

    function stopSegmentTimer(){
      if (segTimer) {
        clearTimeout(segTimer);
        segTimer = null;
      }
    }

    function pauseAudio(){
      stopSegmentTimer();
      try{ audio.pause(); }catch{}
      enable(btnStop, false);
    }

    function scheduleAutoPause(){
      stopSegmentTimer();
      segStartAt = Date.now();
      segTimer = setTimeout(() => {
        pauseAudio();
        setStatus("â¸ï¸ æœ¬æ®µæ’­æ”¾çµæŸï¼<strong>å¯ä»¥çŒœæ­Œ</strong> æˆ–æŒ‰ <strong>ç¹¼çºŒ</strong> å†è½ä¸€æ®µã€‚");
        enable(btnContinue, true);
        enable(btnGuess, true);
        enable(btnReveal, true);
      }, SEGMENT_SECONDS * 1000);
    }

    function updateButtonsForPicked(){
      enable(btnStart, true);
      enable(btnContinue, false);
      enable(btnGuess, true);
      enable(btnReveal, true);
      enable(btnStop, false);
    }

    function updateButtonsForPlaying(){
      enable(btnStart, false);
      enable(btnContinue, false);
      enable(btnGuess, true);
      enable(btnReveal, true);
      enable(btnStop, true);
    }

    function updateButtonsForIdleNoSong(){
      enable(btnStart, false);
      enable(btnContinue, false);
      enable(btnGuess, false);
      enable(btnReveal, false);
      enable(btnStop, false);
    }

    function ensurePool(){
      if (!Array.isArray(SONG_FILES) || SONG_FILES.length === 0) {
        pool = [];
        setRemaining();
        setStatus("âš ï¸ ç›®å‰å°šæœªè¨­å®šæ­Œæ›²æ¸…å–®ã€‚è«‹åˆ°ç¨‹å¼ç¢¼ä¸­å¡«å…¥ <span class=\"mono\">SONG_FILES</span> é™£åˆ—å¾Œå†ä½¿ç”¨ã€‚");
        updateButtonsForIdleNoSong();
        return false;
      }
      if (pool.length === 0) pool = [...SONG_FILES];
      setRemaining();
      return true;
    }

    function pickSong(){
      if (!ensurePool()) return;

      if (pool.length === 0) {
        setStatus("âœ… æ‰€æœ‰æ­Œæ›²éƒ½æ’­æ”¾éäº†ï¼å¯æŒ‰ <strong>é‡è¨­</strong> å†ç©ä¸€è¼ªã€‚");
        updateButtonsForIdleNoSong();
        return;
      }

      // random pick
      const idx = Math.floor(Math.random() * pool.length);
      currentFile = pool.splice(idx, 1)[0];
      currentAnswer = fileToTitle(currentFile);
      round += 1;

      audio.src = "songs/" + encodeURIComponent(currentFile);
      audio.currentTime = 0;
      resetProgress();

      setRemaining();
      setRoundTag("Round " + round);
      setStatus("ğŸ² å·²æŠ½å‡ºé¡Œç›®ï¼æŒ‰ <strong>é–‹å§‹</strong> æ’­æ”¾ç¬¬ä¸€æ®µ 30 ç§’ã€‚");

      updateButtonsForPicked();

      // debug (å¯åˆª)
      debugEl.textContent = "";
    }

    async function playSegment(){
      if (!currentFile) return;

      // æŸäº›ç€è¦½å™¨éœ€è¦ç”±ä½¿ç”¨è€…äº’å‹•è§¸ç™¼ï¼Œé€™è£¡å·²åœ¨æŒ‰éˆ•äº‹ä»¶å…§
      try{
        updateButtonsForPlaying();
        await audio.play();
        setStatus("â–¶ï¸ æ’­æ”¾ä¸­â€¦ï¼ˆ30 ç§’å¾Œè‡ªå‹•æš«åœï¼‰");
        scheduleAutoPause();
        startProgress();
      }catch(err){
        updateButtonsForPicked();
        setStatus("âš ï¸ ç„¡æ³•æ’­æ”¾éŸ³è¨Šã€‚è«‹ç¢ºèªï¼šæª”æ¡ˆå­˜åœ¨æ–¼ songs/ã€æ ¼å¼æ”¯æ´ã€ä¸¦ç”¨æœ¬æ©Ÿä¼ºæœå™¨é–‹å•Ÿï¼ˆä¸è¦ç”¨ç›´æ¥é»æª”æ¡ˆï¼‰ã€‚");
        debugEl.textContent = String(err && err.message ? err.message : err);
      }
    }

    function checkGuess(){
      if (!currentAnswer) return;
      const user = normalize(guessInput.value);
      const ans = normalize(currentAnswer);

      if (!user) {
        setStatus("âŒ¨ï¸ è«‹å…ˆè¼¸å…¥æ­Œåå†æŒ‰ <strong>çŒœæ­Œ</strong>ã€‚");
        return;
      }

      if (user === ans) {
        pauseAudio();
        setStatus("ğŸ‰ <strong>ç­”å°äº†ï¼</strong> é€™é¦–æ­Œæ˜¯ï¼š<span class=\"mono\">" + escapeHtml(currentAnswer) + "</span>ã€‚æŒ‰ <strong>ä¾†ä¸€é¦–</strong> é€²å…¥ä¸‹ä¸€é¡Œï¼");
        // æœ¬é¡ŒçµæŸï¼šæ¸…ç©ºæ¬„ä½
        guessInput.value = "";
        currentFile = null;
        currentAnswer = null;
        resetProgress();
        // å…è¨±ä¸‹ä¸€é¡Œ
        enable(btnStart, false);
        enable(btnContinue, false);
        enable(btnGuess, false);
        enable(btnReveal, false);
        enable(btnStop, false);
        // è‹¥é‚„æœ‰æ­Œï¼Œä¿æŒå¯æŠ½
        enable(btnPick, true);
        setRemaining();
      } else {
        setStatus("âŒ <strong>ç­”éŒ¯äº†</strong>ï¼Œå†è½ä¸€é»å§ï¼å¯ä»¥æŒ‰ <strong>ç¹¼çºŒ</strong> å†æ’­ 30 ç§’ã€‚");
        enable(btnContinue, true);
        enable(btnReveal, true);
      }
    }

    function reveal(){
      if (!currentAnswer) return;
      pauseAudio();
      setStatus("ğŸ” æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<span class=\"mono\">" + escapeHtml(currentAnswer) + "</span>ã€‚æŒ‰ <strong>ä¾†ä¸€é¦–</strong> é€²å…¥ä¸‹ä¸€é¡Œï¼");
      guessInput.value = "";
      currentFile = null;
      currentAnswer = null;
      resetProgress();
      enable(btnStart, false);
      enable(btnContinue, false);
      enable(btnGuess, false);
      enable(btnReveal, false);
      enable(btnStop, false);
      enable(btnPick, true);
      setRemaining();
    }

    function resetGame(){
      pauseAudio();
      pool = [...SONG_FILES];
      currentFile = null;
      currentAnswer = null;
      round = 0;
      resetProgress();
      setRemaining();
      setRoundTag("Round â€”");
      if (!Array.isArray(SONG_FILES) || SONG_FILES.length === 0) {
        setStatus("âš ï¸ è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š <span class=\"mono\">SONG_FILES</span>ï¼ˆæ­Œæ›²æª”åæ¸…å–®ï¼‰ã€‚");
        updateButtonsForIdleNoSong();
      } else {
        setStatus("ğŸ”„ å·²é‡è¨­ï¼æŒ‰ <strong>ä¾†ä¸€é¦–</strong> é–‹å§‹æŠ½æ­Œã€‚");
        updateButtonsForIdleNoSong();
        enable(btnPick, true);
      }
      guessInput.value = "";
      debugEl.textContent = "";
    }

    // ------- Safety: escape -------
    function escapeHtml(str){
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ------- Events -------
    btnPick.addEventListener("click", () => {
      pickSong();
    });

    btnStart.addEventListener("click", () => {
      playSegment();
    });

    btnContinue.addEventListener("click", () => {
      playSegment();
    });

    btnStop.addEventListener("click", () => {
      pauseAudio();
      setStatus("â¸ï¸ å·²æš«åœã€‚å¯æŒ‰ <strong>é–‹å§‹</strong>/<strong>ç¹¼çºŒ</strong> å†æ’­æ”¾ä¸€æ®µã€‚");
      enable(btnStart, true);
      enable(btnContinue, true);
    });

    btnGuess.addEventListener("click", () => {
      // ä½¿ç”¨è€…æŒ‰çŒœæ­Œæ™‚å…ˆæš«åœéŸ³æ¨‚
      if (!audio.paused) {
        pauseAudio();
        setStatus("â¸ï¸ å·²æš«åœæ’­æ”¾ï¼Œæ­£åœ¨åˆ¤æ–·ç­”æ¡ˆâ€¦");
      }
      checkGuess();
    });

    btnReveal.addEventListener("click", () => {
      reveal();
    });

    btnReset.addEventListener("click", () => {
      resetGame();
    });

    guessInput.addEventListener("keydown", (e) => {
      // ä½¿ç”¨è€…é–‹å§‹è¼¸å…¥æ™‚å…ˆæš«åœéŸ³æ¨‚
      if (!audio.paused) {
        pauseAudio();
        setStatus("â¸ï¸ å·²æš«åœæ’­æ”¾ï¼Œè«‹è¼¸å…¥æ­Œåå¾ŒæŒ‰ Enter æˆ–ã€çŒœæ­Œã€ã€‚");
      }
      if (e.key === "Enter") {
        e.preventDefault();
        if (!btnGuess.disabled) checkGuess();
      }
    });

    document.addEventListener("keydown", (e) => {
      // é¿å…åœ¨è¼¸å…¥æ¡†æŒ‰ç©ºç™½éµè¢«æ””æˆª
      const isTyping = document.activeElement === guessInput;
      if (!isTyping && e.code === "Space") {
        e.preventDefault();
        if (!currentFile) return;
        if (audio.paused) {
          playSegment();
        } else {
          pauseAudio();
          setStatus("â¸ï¸ å·²æš«åœã€‚å¯æŒ‰ <strong>é–‹å§‹</strong>/<strong>ç¹¼çºŒ</strong> å†æ’­æ”¾ä¸€æ®µã€‚");
          enable(btnStart, true);
          enable(btnContinue, true);
        }
      }
    });

    // éŸ³è¨Šæ’­å®Œï¼ˆå¦‚æœæ­Œæ›²çŸ­æ–¼ 30 ç§’ï¼‰
    audio.addEventListener("ended", () => {
      stopSegmentTimer();
      enable(btnContinue, false);
      enable(btnStop, false);
      setStatus("ğŸ æ­Œæ›²å·²æ’­å®Œï¼å¯ä»¥ç›´æ¥çŒœæ­Œæˆ–æŒ‰ <strong>çœ‹ç­”æ¡ˆ</strong>ã€‚");
      enable(btnGuess, true);
      enable(btnReveal, true);
      bar.style.width = "100%";
    });

    // åˆå§‹åŒ–
    resetGame();

  </script>
</body>
</html>
